class BWIBBUApp{constructor(){this.apiBase=(location.protocol.startsWith("http")&&location.port==="5003")?"":"http://localhost:5003";this.isRunning=false;this.init()}init(){this.setDefaultDates();this.attachEvents();this.updateStats()}setDefaultDates(){const t=new Date(),e=new Date(t.getTime()-30*24*60*60*1e3);const n=document.getElementById('bwibbuEndDate');if(n)n.valueAsDate=t;const a=document.getElementById('bwibbuStartDate');if(a)a.valueAsDate=e}updateStats(tw=0,tp=0,tot=0,days=0){const t=document.getElementById('bwibbuStatTWSE');if(t)t.textContent=tw>0?tw.toLocaleString():'--';const e=document.getElementById('bwibbuStatTPEX');if(e)e.textContent=tp>0?tp.toLocaleString():'--';const n=document.getElementById('bwibbuStatTotal');if(n)n.textContent=tot>0?tot.toLocaleString():'--';const a=document.getElementById('bwibbuStatDays');if(a)a.textContent=days>0?days:'--'}log(t,e='info'){const n=document.getElementById('bwibbuLogPanel');if(!n)return;const a=document.createElement('div');a.className=`log-line ${e}`;const s=new Date().toLocaleTimeString('zh-TW');const c={'info':'#667eea','success':'#38ef7d','error':'#f5576c','warn':'#fee140'};a.style.cssText=`padding:0.5rem;border-left:3px solid ${c[e]||'#667eea'};background:${e==='success'?'rgba(56,239,125,0.1)':e==='error'?'rgba(245,87,108,0.1)':'rgba(102,126,234,0.05)'};margin-bottom:0.25rem;border-radius:4px;`;a.innerHTML=`<span style="color:#6c757d;font-weight:600;">[${s}]</span> <span style="color:#212529;">${t}</span>`;n.appendChild(a);n.scrollTop=n.scrollHeight}setProgress(t,e){const n=document.getElementById('bwibbuProgressFill');if(n)n.style.width=`${t}%`;const a=document.getElementById('bwibbuProgressText');if(a)a.textContent=e||`${t}%`}async startBackfill(){if(this.isRunning)return;const t=document.getElementById('bwibbuStartDate')?.value,e=document.getElementById('bwibbuEndDate')?.value,n=document.getElementById('bwibbuDbSelect')?.value;if(!t||!e)return alert('請選擇開始和結束日期');this.isRunning=true;const a=document.getElementById('bwibbuBackfillBtn');if(a)a.disabled=true;document.getElementById('bwibbuProgressSection')?.classList.add('active');document.getElementById('bwibbuResultsSection')?.classList.remove('active');const s=document.getElementById('bwibbuLogPanel');if(s)s.innerHTML='';this.log(`開始回朔：${t} 至 ${e}（${n==='neon'?'Neon':'本地'}）`,'info');this.setProgress(10,'開始');try{const i=await fetch(`${this.apiBase}/api/bwibbu/backfill`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({start:t,end:e,use_local_db:n==='local',skip_existing:document.getElementById('bwibbuSkipExisting')?.checked})});const r=await i.json();if(r.success){ this.log(`完成，寫入 ${r.total_records||0} 筆`,'success');if(r.daily_stats){Object.keys(r.daily_stats).sort().forEach(d=>{const k=r.daily_stats[d];const twse = (k.twse_count!==undefined)?`，TWSE ${k.twse_count}`:'';const tpex = (k.tpex_count!==undefined)?`，TPEX ${k.tpex_count}`:'';this.log(`- ${d} | 寫入 ${k.inserted||0} 筆，共 ${k.total_count||0}${twse}${tpex}`,'info')})}this.showResults(r)
}else{this.log(`失敗：${r.error}`,'error')}this.setProgress(100,'完成')}catch(o){this.log(`網路錯誤：${o.message}`,'error')}finally{this.isRunning=false;if(a)a.disabled=false}}showResults(t){const e=document.getElementById('bwibbuResultsSection');const n=document.getElementById('bwibbuResultMessage');if(n)n.textContent=t.message||'';const a=document.getElementById('bwibbuResultCount');if(a)a.textContent=`總筆數：${(t.total_records||0).toLocaleString()}`;const s=document.getElementById('bwibbuDatesList');if(s){s.innerHTML='';const i=t.available_dates||t.dates||[];if(i.length>0){i.forEach(r=>{const o=document.createElement('span');o.style.cssText='display:inline-block;padding:0.5rem 1rem;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border-radius:6px;font-size:0.875rem;font-weight:600;box-shadow:0 2px 8px rgba(102,126,234,0.3);';o.textContent=r;s.appendChild(o)})}else{s.innerHTML='<span style="color:#6c757d;font-style:italic;">無可用日期</span>'}}e?.classList.add('active');let tw=0,tp=0,tot=t.total_records||0,days=(t.available_dates||t.dates||[]).length;if(t.daily_stats){Object.values(t.daily_stats).forEach(d=>{tw+=(d.twse_count||0);tp+=(d.tpex_count||0)})}this.updateStats(tw,tp,tot,days)}async query(){const t=document.getElementById('bwibbuStartDate')?.value,e=document.getElementById('bwibbuEndDate')?.value,n=document.getElementById('bwibbuDbSelect')?.value;try{const a=new URLSearchParams();if(n==='local')a.set('use_local_db','true');if(t)a.set('start',t);if(e)a.set('end',e);const s=await fetch(`${this.apiBase}/api/bwibbu/query?${a.toString()}`);const i=await s.json();if(i.success){this.log(`查詢完成：${i.total_count} 筆，${(i.dates||[]).length} 個日期`,'info');this.showResults({message:'查詢成功',total_records:i.total_count,available_dates:i.dates})}else{this.log(`查詢失敗：${i.error}`,'error')}}catch(r){this.log(`查詢錯誤：${r.message}`,'error')}}attachEvents(){document.getElementById('bwibbuBackfillBtn')?.addEventListener('click',()=>this.startBackfill());document.getElementById('bwibbuQueryBtn')?.addEventListener('click',()=>this.query())}}document.addEventListener('DOMContentLoaded',()=>{window.__bwibbuApp=new BWIBBUApp()});

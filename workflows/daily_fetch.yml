name: Daily Stock Data Fetch

on:
  schedule:
    # æ¯æ—¥ 15:30 åŸ·è¡Œï¼ˆUTC+8 = UTC+0 + 8ï¼Œæ‰€ä»¥ 15:30 = 07:30 UTCï¼‰
    - cron: '30 7 * * 1-5'  # é€±ä¸€è‡³é€±äº” 15:30 (å°åŒ—æ™‚é–“)
  
  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

env:
  TZ: Asia/Taipei

jobs:
  fetch-stock-data:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install psycopg2-binary requests pandas numpy beautifulsoup4 lxml flask flask-cors
    
    - name: Fetch stock data and sync to Neon
      env:
        NEON_DATABASE_URL: ${{ secrets.NEON_DATABASE_URL }}
      run: |
        python3 << 'PYTHON_SCRIPT'
        import os
        import sys
        import time
        import requests
        import psycopg2
        from psycopg2.extras import execute_values, RealDictCursor
        from datetime import datetime, date, timedelta
        import json
        from bs4 import BeautifulSoup
        import pandas as pd
        
        print("=" * 80)
        print("ğŸš€ é–‹å§‹åŸ·è¡Œ GitHub Actions è‚¡åƒ¹è³‡æ–™æŠ“å–ä»»å‹™")
        print("=" * 80)
        print(f"â° åŸ·è¡Œæ™‚é–“ï¼š{datetime.now()}")
        print(f"ğŸ“… ç›®æ¨™æ—¥æœŸï¼š{date.today()}")
        print()
        
        # é€£æ¥ Neon è³‡æ–™åº«
        NEON_DB_URL = os.environ.get('NEON_DATABASE_URL')
        
        if not NEON_DB_URL:
            print("âŒ éŒ¯èª¤ï¼šæœªè¨­å®š NEON_DATABASE_URL")
            print("è«‹åœ¨ GitHub Settings â†’ Secrets ä¸­è¨­å®š NEON_DATABASE_URL")
            sys.exit(1)
        
        try:
            conn = psycopg2.connect(NEON_DB_URL)
            cur = conn.cursor()
            print("âœ… å·²é€£æ¥åˆ° Neon è³‡æ–™åº«")
            print()
            
        except Exception as e:
            print(f"âŒ è³‡æ–™åº«é€£ç·šå¤±æ•—ï¼š{e}")
            sys.exit(1)
        
        # ========================================
        # å‡½æ•¸ï¼šæŠ“å–ä¸Šå¸‚è‚¡ç¥¨è³‡æ–™ (TWSE)
        # ========================================
        def fetch_twse_data(target_date):
            """æŠ“å–ä¸Šå¸‚è‚¡ç¥¨è³‡æ–™"""
            print("ğŸ“Š é–‹å§‹æŠ“å–ä¸Šå¸‚è‚¡ç¥¨è³‡æ–™ (TWSE)...")
            
            date_str = target_date.strftime('%Y%m%d')
            url = f'https://www.twse.com.tw/exchangeReport/MI_INDEX?response=json&date={date_str}&type=ALLBUT0999'
            
            try:
                response = requests.get(url, timeout=30)
                response.raise_for_status()
                data = response.json()
                
                if data.get('stat') != 'OK':
                    print(f"âš ï¸  ä¸Šå¸‚è‚¡ç¥¨è³‡æ–™å°šæœªå…¬å¸ƒæˆ–éäº¤æ˜“æ—¥")
                    return []
                
                records = []
                for row in data.get('data9', []):
                    try:
                        symbol = row[0].strip()
                        if not symbol.isdigit():
                            continue
                        
                        # è§£æåƒ¹æ ¼è³‡æ–™
                        open_price = float(row[5].replace(',', '')) if row[5] != '--' else None
                        high_price = float(row[6].replace(',', '')) if row[6] != '--' else None
                        low_price = float(row[7].replace(',', '')) if row[7] != '--' else None
                        close_price = float(row[8].replace(',', '')) if row[8] != '--' else None
                        volume = int(row[2].replace(',', '')) if row[2] != '--' else 0
                        transaction_count = int(row[3].replace(',', '')) if row[3] != '--' else 0
                        
                        if close_price:
                            records.append((
                                symbol, target_date, open_price, high_price,
                                low_price, close_price, volume, transaction_count
                            ))
                    except (ValueError, IndexError) as e:
                        continue
                
                print(f"âœ… ä¸Šå¸‚è‚¡ç¥¨ï¼šæˆåŠŸæŠ“å– {len(records)} ç­†è³‡æ–™")
                return records
                
            except Exception as e:
                print(f"âŒ æŠ“å–ä¸Šå¸‚è‚¡ç¥¨è³‡æ–™å¤±æ•—ï¼š{e}")
                return []
        
        # ========================================
        # å‡½æ•¸ï¼šæŠ“å–ä¸Šæ«ƒè‚¡ç¥¨è³‡æ–™ (TPEX)
        # ========================================
        def fetch_tpex_data(target_date):
            """æŠ“å–ä¸Šæ«ƒè‚¡ç¥¨è³‡æ–™"""
            print("ğŸ“Š é–‹å§‹æŠ“å–ä¸Šæ«ƒè‚¡ç¥¨è³‡æ–™ (TPEX)...")
            
            # è½‰æ›æ—¥æœŸæ ¼å¼ç‚ºæ°‘åœ‹å¹´
            year = target_date.year - 1911
            month = target_date.month
            day = target_date.day
            date_str = f'{year}/{month:02d}/{day:02d}'
            
            url = f'https://www.tpex.org.tw/web/stock/aftertrading/otc_quotes_no1430/stk_wn1430_result.php?l=zh-tw&d={date_str}&se=AL'
            
            try:
                response = requests.get(url, timeout=30)
                response.raise_for_status()
                data = response.json()
                
                if data.get('aaData') is None:
                    print(f"âš ï¸  ä¸Šæ«ƒè‚¡ç¥¨è³‡æ–™å°šæœªå…¬å¸ƒæˆ–éäº¤æ˜“æ—¥")
                    return []
                
                records = []
                for row in data.get('aaData', []):
                    try:
                        symbol = row[0].strip()
                        if not symbol.isdigit():
                            continue
                        
                        close_price = float(row[2].replace(',', '')) if row[2] != '-' else None
                        open_price = float(row[4].replace(',', '')) if row[4] != '-' else None
                        high_price = float(row[5].replace(',', '')) if row[5] != '-' else None
                        low_price = float(row[6].replace(',', '')) if row[6] != '-' else None
                        volume = int(row[7].replace(',', '')) * 1000 if row[7] != '-' else 0
                        
                        if close_price:
                            records.append((
                                symbol, target_date, open_price, high_price,
                                low_price, close_price, volume, 0
                            ))
                    except (ValueError, IndexError) as e:
                        continue
                
                print(f"âœ… ä¸Šæ«ƒè‚¡ç¥¨ï¼šæˆåŠŸæŠ“å– {len(records)} ç­†è³‡æ–™")
                return records
                
            except Exception as e:
                print(f"âŒ æŠ“å–ä¸Šæ«ƒè‚¡ç¥¨è³‡æ–™å¤±æ•—ï¼š{e}")
                return []
        
        # ========================================
        # ä¸»è¦åŸ·è¡Œæµç¨‹
        # ========================================
        try:
            today = date.today()
            
            # 1. æŠ“å–ä¸Šå¸‚è‚¡ç¥¨è³‡æ–™
            twse_records = fetch_twse_data(today)
            time.sleep(3)  # é¿å…è«‹æ±‚éå¿«
            
            # 2. æŠ“å–ä¸Šæ«ƒè‚¡ç¥¨è³‡æ–™
            tpex_records = fetch_tpex_data(today)
            
            # 3. åˆä½µè³‡æ–™
            all_records = twse_records + tpex_records
            
            if not all_records:
                print("âš ï¸  ä»Šæ—¥ç„¡è³‡æ–™å¯åŒæ­¥ï¼ˆå¯èƒ½æ˜¯éäº¤æ˜“æ—¥æˆ–è³‡æ–™å°šæœªå…¬å¸ƒï¼‰")
                print("âœ… ä»»å‹™å®Œæˆï¼ˆç„¡è³‡æ–™æ›´æ–°ï¼‰")
                sys.exit(0)
            
            print()
            print(f"ğŸ“¦ æº–å‚™åŒæ­¥ {len(all_records)} ç­†è³‡æ–™åˆ° Neon è³‡æ–™åº«...")
            
            # 4. æ‰¹æ¬¡æ’å…¥åˆ° Neon è³‡æ–™åº«
            execute_values(
                cur,
                """
                INSERT INTO stock_prices 
                (symbol, date, open_price, high_price, low_price, 
                 close_price, volume, transaction_count)
                VALUES %s
                ON CONFLICT (symbol, date) 
                DO UPDATE SET
                    open_price = EXCLUDED.open_price,
                    high_price = EXCLUDED.high_price,
                    low_price = EXCLUDED.low_price,
                    close_price = EXCLUDED.close_price,
                    volume = EXCLUDED.volume,
                    transaction_count = EXCLUDED.transaction_count
                """,
                all_records
            )
            
            conn.commit()
            
            print(f"âœ… æˆåŠŸåŒæ­¥ {len(all_records)} ç­†è³‡æ–™åˆ° Neon")
            print()
            print("=" * 80)
            print("ğŸ‰ GitHub Actions ä»»å‹™åŸ·è¡Œå®Œæˆï¼")
            print("=" * 80)
            
        except Exception as e:
            print(f"âŒ åŸ·è¡Œéç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼š{e}")
            import traceback
            traceback.print_exc()
            sys.exit(1)
            
        finally:
            if cur:
                cur.close()
            if conn:
                conn.close()
        PYTHON_SCRIPT
    
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: fetch-logs-${{ github.run_number }}
        path: |
          *.log
        retention-days: 30
    
    - name: Send notification on failure
      if: failure()
      run: |
        echo "âŒ è³‡æ–™æŠ“å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ—¥èªŒ"
        echo "Run ID: ${{ github.run_id }}"
        echo "Run Number: ${{ github.run_number }}"
